Ниже — обзор **консистентности** по тому, что видно из структуры и приложенных `docker-compose*.yml` + `SETUP.md`, и список **необходимых исправлений/доработок**, чтобы шаблон был предсказуемым и не “ломался” на ровном месте.

---

## 1) Docker Compose: логика сервисов и зависимостей

### 1.1 `depends_on` в dev-оверлее может сломать ожидания из базового `docker-compose.yml`
В `docker-compose.yml` у `laravel-nginx-tcp` есть:

- зависимость от `laravel-php-nginx-tcp` **с условием** `condition: service_healthy`

А в `docker-compose.dev.yml` у того же сервиса:

- `depends_on: - laravel-node-nginx-tcp`

В Docker Compose мерджинг полей для одного и того же сервиса/ключа — штука коварная: в зависимости от реализации/версии плагина часть ключей может **перетираться**, а не “умно объединяться”. Риск: в dev Nginx начнёт стартовать без ожидания healthcheck PHP-FPM.

**Исправление (необходимо):**
- В `docker-compose.dev.yml` у `laravel-nginx-tcp` явно задать `depends_on`, включив **и PHP (с health)**, и Node (без health, просто порядок старта).

### 1.2 Зависимость Nginx от Node — спорная и может мешать
Nginx как веб-сервер для Laravel обычно должен зависеть от **PHP-FPM**, а Node/Vite — это “удобство” для HMR, но не блокер для поднятия backend’а. Если Node упал — сайт на PHP всё равно должен открываться (а ассеты/Vite — уже вторично).

**Исправление (рекомендуемо, но на практике почти всегда нужно):**
- Сделать Node **опциональным**: не блокировать старт Nginx’а из‑за Node, либо вынести Vite в отдельный профиль (`profiles`) и не включать в дефолтный `make up`.

---

## 2) Docker Compose: сети и “мертвые” декларации

### 2.1 В `docker-compose.yml` объявлена внешняя сеть `redis-cluster-dev`, но она нигде не используется
Сейчас есть:

```yaml
networks:
  redis-cluster-dev:
    external: true
```


Но ни один сервис не подключён к этой сети.

**Почему это проблема:**
- Лишний “контракт” в конфигурации, создаёт вопросы и ошибки в CI/на машинах, где сеть не создана (в зависимости от того, как запускают compose).
- Противоречит описанию “Redis внешний (managed)” — если он реально внешний (вне Docker), сеть Docker вообще не нужна.

**Исправление (необходимо — выбрать один вариант):**
- Либо **удалить** `redis-cluster-dev` из `docker-compose.yml`, если Redis действительно “снаружи Docker”.
- Либо **подключить** к ней сервис(ы), которым нужно ходить в Redis, если Redis живёт в другом compose-проекте в Docker.

### 2.2 `postgres-dev-network` подключён только к PHP — это ок, но документировать нужно чётче
В `docker-compose.yml` PHP подключён к `postgres-dev-network`, Nginx — нет. Это логично: Nginx к БД не ходит.

**Исправление (документационное, но важно):**
- В `SETUP.md` явно указать: сеть БД нужна **только контейнеру PHP**, поэтому подключение Nginx к ней не требуется.

---

## 3) Healthcheck PHP-FPM: возможная неработоспособность из-за отсутствия `cgi-fcgi`

В `docker-compose.yml` healthcheck PHP:

```yaml
cgi-fcgi -bind -connect 127.0.0.1:9000 | grep -q 'pong'
```


**Риск:**
- В PHP-образе может не быть утилиты `cgi-fcgi` (обычно это пакет вроде `libfcgi-bin`). Тогда healthcheck всегда будет падать → Nginx не поднимется (т.к. ждёт `service_healthy`).

**Исправление (необходимо):**
- Проверить Dockerfile (`docker/php.*.Dockerfile`) и гарантировать установку `cgi-fcgi`, либо заменить healthcheck на более надёжный вариант (например, проверка доступности порта 9000 через `nc`/`bash`), но с учётом того, что утилиты тоже должны быть в образе.

---

## 4) Консистентность монтирования кода и прав (dev)

В dev вы монтируете проект в:
- PHP (`.:/var/www/laravel`)
- Nginx (`.:/var/www/laravel`)
- Node (`.:/var/www/laravel` + отдельный volume на `node_modules`)

Это стандартно, но есть типовые “краевые случаи”:

**Риски:**
- `node_modules` в volume ок, но если `package-lock.json`/версия Node меняются — возможны странные состояния.
- Права на `storage/` и `bootstrap/cache` на macOS обычно терпимы, но иногда ломаются при `root` внутри контейнера.

**Исправления (желательно, чтобы шаблон был стабильным):**
- В `Makefile`/setup-скрипте явно фиксировать права и владельца (вы это уже упоминаете в `SETUP.md`, но хорошо бы убедиться, что это реально реализовано).
- Для Node добавить простой healthcheck или хотя бы “понятное падение” (например, печать `node -v`, `npm -v` перед установкой), чтобы диагностика была проще.

---

## 5) Документация (`SETUP.md`) — мелкие, но важные несостыковки

### 5.1 Форматирование Markdown-кодов местами сломано
В `SETUP.md` встречаются блоки вида:

```
bash
composer create-project laravel/laravel .
```


Это выглядит как code fence, но без тройных бектиков вокруг `bash`/`dotenv`. В результате на GitLab/GitHub часть блоков будет отображаться “криво”.

**Исправление (необходимо):**
- Привести все блоки к виду:

```markdown

```
bash
...
```

```


(То же для `dotenv`, `yml`, `sql`.)

### 5.2 Уточнить про `DB_HOST` для “external DB”
Сейчас текст местами смешивает кейсы:
- “managed DB/вне Docker”
- “DB в другом compose-проекте”

**Исправление (рекомендуемо):**
- Явно разделить 2 сценария:
    1) **DB вне Docker** → `DB_HOST` = DNS/host, сети Docker не нужны.
    2) **DB в Docker (другой compose)** → нужна общая external network, `DB_HOST` = имя сервиса/контейнера в этой сети.

---

## 6) Версии и “контракты” окружения

### 6.1 Node `node:24-alpine` — очень свежо и может ломать старые toolchains
Если проект рассчитан как boilerplate “для всех”, Node 24 может быть слишком новым для части зависимостей.

**Исправление (по ситуации, но часто нужно):**
- Зафиксировать версию Node под LTS (например, 20/22), либо явно написать в документации: “Node 24 требуется”.

### 6.2 Переменные окружения: где источник истины?
Есть `.env.docker` как “шпаргалка”, но не видно:
- есть ли `.env.example` (Laravel обычно его держит)
- как синхронизируются переменные для Compose и Laravel `.env`

**Исправление (рекомендуемо):**
- В README/SETUP чётко указать:
    - какие переменные читает **Docker Compose** (`NGINX_PORT`, `XDEBUG_*`)
    - какие читает **Laravel** (`DB_*`, `REDIS_*`)
    - откуда они берутся (один `.env` или два разных файла)

---

## 7) Мини-чеклист правок (в порядке приоритета)

1) **Dev overlay:** исправить `depends_on` у `laravel-nginx-tcp`, чтобы не потерять ожидание `php: healthy` и не блокироваться на Node.
2) **Healthcheck PHP:** гарантировать наличие `cgi-fcgi` (или заменить проверку), иначе `service_healthy` не заработает.
3) **Сети:** удалить `redis-cluster-dev` из `docker-compose.yml` *или* подключить сервисы к ней — сейчас это “мертвый” кусок конфига.
4) **SETUP.md:** починить Markdown fenced code blocks (````
5) **Документация по DB:** развести сценарии “DB вне Docker” vs “DB в Docker через external network”.
6) **Версии Node:** либо зафиксировать LTS, либо документировать необходимость Node 24.

---

Если хочешь, я могу пройтись **точнее по репозиторию** (Makefile, Dockerfile’ы PHP/Nginx, `docker-compose.prod.yml`, CI) и составить финальный список “что именно и где править” с конкретными правками. Для этого нужно содержимое этих файлов — сейчас их в вложениях нет.
```
